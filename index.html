<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PrekClip</title>
    <style>
        /* --- STYLES (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
        :root {
            --primary: #2962FF; /* –Ø—Ä–∫–∏–π —Å–∏–Ω–∏–π */
            --bg: #000000;
            --surface: #121212;
            --surface-light: #1E1E1E;
            --text: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #333333;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* SVG & Icons */
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .icon-lg { width: 32px; height: 32px; fill: currentColor; }
        .icon-nav { width: 22px; height: 22px; margin-bottom: 4px; fill: currentColor; }

        /* Verified Badge */
        .verified-badge {
            width: 14px; height: 14px;
            background: var(--primary);
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-left: 4px;
            flex-shrink: 0;
        }
        .verified-badge svg {
            fill: white;
            width: 8px;
            height: 8px;
        }
        
        /* Components */
        button {
            border: none; cursor: pointer; font-weight: 600; transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }

        .btn-primary {
            background-color: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; width: 100%; font-size: 16px;
        }

        .btn-small {
            background: var(--surface-light); color: var(--text); padding: 6px 12px; border-radius: 4px; font-size: 13px;
        }
        .btn-small.active { background: var(--primary); color: white; }

        input, textarea {
            background: var(--surface-light); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 12px; font-size: 15px;
        }
        input:focus, textarea:focus { border-color: var(--primary); }

        /* Views & Animations */
        .view {
            flex: 1; overflow-y: auto; display: none; padding-bottom: var(--nav-height); animation: fadeIn 0.3s ease;
        }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Auth Screen */
        #view-auth {
            display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 30px; background: linear-gradient(180deg, #000 0%, #0d1b3e 100%); z-index: 9000;
        }
        .logo { font-size: 40px; font-weight: 800; color: var(--primary); margin-bottom: 10px; letter-spacing: -1px; }
        .auth-toggle { color: var(--text-secondary); margin-top: 20px; font-size: 14px; cursor: pointer; }
        .auth-toggle span { color: var(--primary); font-weight: bold; }

        /* Navbar */
        .navbar {
            position: fixed; bottom: 0; width: 100%; height: var(--nav-height);
            background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #666; font-size: 10px; cursor: pointer; width: 20%;
        }
        .nav-item.active { color: white; }
        .nav-add {
            width: 45px; height: 30px;
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
        }
        .nav-add svg { fill: #000; width: 20px; height: 20px; }

        /* Feed Post */
        .post {
            position: relative; background: #000; border-bottom: 1px solid var(--surface-light); margin-bottom: 10px;
        }
        .post-header {
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
        }
        .avatar-circle {
            width: 36px; height: 36px; border-radius: 50%; background: #333; object-fit: cover;
        }
        .username-container { display: flex; align-items: center; }
        .username { font-weight: 700; font-size: 14px; }
        
        .post-media-container {
            width: 100%; background: #101010; display: flex; justify-content: center; align-items: center; min-height: 300px;
        }
        .post-media { width: 100%; max-height: 70vh; object-fit: contain; }

        .post-actions-bar {
            padding: 10px 15px; display: flex; justify-content: space-between;
        }
        .action-group { display: flex; gap: 20px; }
        .action-btn { background: none; padding: 0; display: flex; align-items: center; gap: 6px; color: white; }
        .action-btn span { font-size: 14px; font-weight: 600; }
        
        .liked svg { fill: #ff1744; animation: heartBeat 0.3s; }
        @keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .post-caption { padding: 0 15px 15px; font-size: 14px; color: #ddd; line-height: 1.4; }
        .post-caption b { color: white; margin-right: 5px; }

        /* Comments */
        .comments-sheet {
            display: none; background: var(--surface); padding: 15px; border-top: 1px solid var(--border);
        }
        .comment-item { margin-bottom: 10px; font-size: 13px; display: flex; gap: 10px; }
        .comment-username { display: flex; align-items: center; font-weight: bold; flex-shrink: 0; }

        /* Profile */
        .profile-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--border); }
        .profile-avatar { width: 90px; height: 90px; border-radius: 50%; margin-bottom: 15px; border: 2px solid var(--primary); object-fit: cover; }
        .stats-row { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-box { text-align: center; }
        .stat-num { display: block; font-weight: 700; font-size: 18px; }
        .stat-label { font-size: 12px; color: var(--text-secondary); }
        
        .grid-posts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; margin-top: 1px; }
        .grid-item { aspect-ratio: 1; background: #222; position: relative; cursor: pointer; }
        .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; }

        /* Search & Inbox */
        .search-container { padding: 15px; }
        .user-list-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .inbox-msg { padding: 20px; text-align: center; color: var(--text-secondary); font-style: italic; }

        /* Upload */
        .upload-area {
            border: 2px dashed var(--border); border-radius: 10px; height: 200px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; color: var(--text-secondary); cursor: pointer;
        }
        .upload-preview { width: 100%; height: 100%; object-fit: contain; display: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <svg style="display:none">
        <symbol id="icon-home" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
        <symbol id="icon-mail" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></symbol>
        <symbol id="icon-user" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
        <symbol id="icon-heart" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></symbol>
        <symbol id="icon-comment" viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></symbol>
    </svg>

    <div id="view-auth" class="view active" style="position: absolute; top:0; left:0; width:100%; z-index:9000;">
        <div class="logo">PrekClip</div>
        
        <div id="form-login" style="width: 100%; max-width: 320px;">
            <p style="color:white; text-align:center; font-size:12px;">–†–∞–±–æ—Ç–∞–µ–º –Ω–∞ –æ–¥–Ω–æ–º –ø–æ—Ä—Ç—É! –û—à–∏–±–æ–∫ —Å–µ—Ç–∏ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.</p>
            <input type="text" id="login-u" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="login-p" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-primary" onclick="app.login()">–í–æ–π—Ç–∏</button>
            <div class="auth-toggle" onclick="app.toggleAuth(true)">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span>–°–æ–∑–¥–∞—Ç—å</span></div>
        </div>

        <div id="form-register" class="hidden" style="width: 100%; max-width: 320px;">
            <input type="text" id="reg-u" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫">
            <input type="password" id="reg-p" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button class="btn-primary" onclick="app.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div class="auth-toggle" onclick="app.toggleAuth(false)">–£–∂–µ –µ—Å—Ç—å? <span>–í–æ–π—Ç–∏</span></div>
        </div>
    </div>

    <div id="view-home" class="view"></div>

    <div id="view-search" class="view">
        <div class="search-container">
            <input type="text" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="app.search(this.value)">
            <div id="search-results"></div>
        </div>
    </div>

    <div id="view-upload" class="view">
        <div style="padding: 20px;">
            <h2>–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</h2>
            <div class="upload-area" onclick="document.getElementById('file-inp').click()">
                <span id="upload-txt">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                <img id="upload-prev" class="upload-preview">
                <video id="upload-vid" class="upload-preview" controls></video>
            </div>
            <input type="file" id="file-inp" class="hidden" accept="image/*,video/*" onchange="app.previewFile(this)">
            <textarea id="upload-cap" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
            <button class="btn-primary" onclick="app.uploadPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <div id="view-inbox" class="view">
        <h2 style="padding: 15px 20px; border-bottom: 1px solid var(--border); margin:0;">–í—Ö–æ–¥—è—â–∏–µ</h2>
        <div class="inbox-msg">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
    </div>

    <div id="view-profile" class="view">
        <div id="profile-cont"></div>
    </div>

    <nav class="navbar hidden" id="main-nav">
        <div class="nav-item active" onclick="app.nav('view-home')">
            <svg class="icon-nav"><use href="#icon-home"/></svg>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="app.nav('view-search')">
            <svg class="icon-nav"><use href="#icon-search"/></svg>
            <span>–ü–æ–∏—Å–∫</span>
        </div>
        <div class="nav-item" onclick="app.nav('view-upload')">
            <div class="nav-add"><svg><use href="#icon-plus"/></svg></div>
        </div>
        <div class="nav-item" onclick="app.nav('view-inbox')">
            <svg class="icon-nav"><use href="#icon-mail"/></svg>
            <span>–í—Ö–æ–¥—è—â–∏–µ</span>
        </div>
        <div class="nav-item" onclick="app.nav('view-profile')">
            <svg class="icon-nav"><use href="#icon-user"/></svg>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        // *** üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–î–ê–õ–Ø–ï–ú API_BASE_URL –ò –ò–°–ü–û–õ–¨–ó–£–ï–ú –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–´–ï –ü–£–¢–ò üö® ***
        // const API_BASE_URL = window.location.origin; // (–≠—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ '/')
        
        const app = {
            user: null,

            getVerifiedBadge: (isVerified) => {
                if (!isVerified) return '';
                return `<div class="verified-badge" title="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç"><svg><use href="#icon-check"/></svg></div>`;
            },

            // --- AUTH ---
            toggleAuth: (toRegister) => {
                document.getElementById('form-login').classList.toggle('hidden', toRegister);
                document.getElementById('form-register').classList.toggle('hidden', !toRegister);
            },

            async register() {
                const u = document.getElementById('reg-u').value;
                const p = document.getElementById('reg-p').value;
                if(!u || !p) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
                
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: /auth/register
                    const res = await fetch(`/auth/register`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: u, password: p })
                    });
                    const data = await res.json();
                    if(data.error) alert(data.error);
                    else { alert('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–æ–π–¥–∏—Ç–µ.'); this.toggleAuth(false); }
                } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.'); }
            },

            async login() {
                const u = document.getElementById('login-u').value;
                const p = document.getElementById('login-p').value;
                
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: /auth/login
                    const res = await fetch(`/auth/login`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: u, password: p })
                    });
                    const data = await res.json();
                    if(data.error) alert(data.error);
                    else {
                        this.user = data.user;
                        document.getElementById('view-auth').classList.remove('active');
                        document.getElementById('main-nav').classList.remove('hidden');
                        this.nav('view-home');
                    }
                } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ –≤—Ö–æ–¥–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.'); }
            },

            // --- NAV ---
            nav(viewId) {
                document.querySelectorAll('.view:not(#view-auth)').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                
                const icons = ['view-home', 'view-search', 'view-upload', 'view-inbox', 'view-profile'];
                const items = document.querySelectorAll('.nav-item');
                items.forEach(el => el.classList.remove('active'));
                if(viewId !== 'view-upload') items[icons.indexOf(viewId)].classList.add('active');

                if(viewId === 'view-home') this.loadFeed();
                if(viewId === 'view-profile') this.loadProfile(this.user.id);
            },

            // --- FEED ---
            async loadFeed() {
                const cont = document.getElementById('view-home');
                cont.innerHTML = '<div style="padding:20px;text-align:center;color:#666">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã...</div>';
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: /posts/feed
                const res = await fetch(`/posts/feed`);
                const posts = await res.json();
                
                cont.innerHTML = '';
                posts.forEach(post => {
                    const isLiked = post.likes.includes(this.user.id);
                    // –ú–µ–¥–∏–∞-—Ñ–∞–π–ª—ã —Ç–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–º—É –ø—É—Ç–∏ /uploads/...
                    const mediaHtml = post.type === 'video'
                        ? `<video src="${post.src}" class="post-media" controls loop playsinline></video>`
                        : `<img src="${post.src}" class="post-media">`;
                    
                    const verifiedBadge = this.getVerifiedBadge(post.authorVerified);

                    const html = `
                        <div class="post">
                            <div class="post-header" onclick="app.loadProfile('${post.userId}'); app.nav('view-profile')">
                                <img src="${post.authorAvatar ? post.authorAvatar : 'https://via.placeholder.com/40/333/333'}" class="avatar-circle">
                                <div class="username-container">
                                    <span class="username">${post.authorName}</span>
                                    ${verifiedBadge}
                                </div>
                            </div>
                            <div class="post-media-container">${mediaHtml}</div>
                            <div class="post-actions-bar">
                                <div class="action-group">
                                    <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="app.toggleLike('${post.id}', this)">
                                        <svg class="icon-lg"><use href="#icon-heart"/></svg>
                                        <span>${post.likes.length}</span>
                                    </button>
                                    <button class="action-btn" onclick="app.toggleComments('${post.id}')">
                                        <svg class="icon-lg"><use href="#icon-comment"/></svg>
                                        <span>${post.comments.length}</span>
                                    </button>
                                </div>
                                <button class="action-btn" onclick="app.sharePost('${post.id}')">
                                    <svg class="icon-lg"><use href="#icon-share"/></svg>
                                </button>
                            </div>
                            <div class="post-caption"><b>${post.authorName}</b> ${post.caption}</div>
                            <div id="comments-${post.id}" class="comments-sheet">
                                <div class="list">
                                    ${post.comments.map(c => `
                                        <div class="comment-item">
                                            <div class="comment-username">
                                                <span>${c.username}</span>
                                                ${this.getVerifiedBadge(c.isVerified)}:
                                            </div>
                                             ${c.text}
                                        </div>
                                    `).join('')}
                                </div>
                                <input type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å..." onkeydown="if(event.key==='Enter') app.sendComment('${post.id}', this)">
                            </div>
                        </div>
                    `;
                    cont.innerHTML += html;
                });
            },

            // --- ACTIONS ---
            async toggleLike(pid, btn) {
                const res = await fetch(`/action/like`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ postId: pid, userId: this.user.id })
                });
                const data = await res.json();
                btn.classList.toggle('liked', data.isLiked);
                btn.querySelector('span').innerText = data.likesCount;
            },

            toggleComments(pid) {
                const el = document.getElementById(`comments-${pid}`);
                el.style.display = el.style.display === 'block' ? 'none' : 'block';
            },

            async sendComment(pid, input) {
                if(!input.value.trim()) return;
                const res = await fetch(`/action/comment`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ postId: pid, userId: this.user.id, text: input.value })
                });
                const c = await res.json();
                
                const list = input.previousElementSibling;
                list.innerHTML += `
                    <div class="comment-item">
                        <div class="comment-username">
                            <span>${c.username}</span>
                            ${this.getVerifiedBadge(c.isVerified)}:
                        </div>
                         ${c.text}
                    </div>
                `;
                input.value = '';
            },

            sharePost(pid) {
                const link = `${window.location.origin}/#post-${pid}`;
                navigator.clipboard.writeText(link);
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            },

            // --- UPLOAD ---
            previewFile(input) {
                const file = input.files[0];
                if(!file) return;
                
                const txt = document.getElementById('upload-txt');
                const img = document.getElementById('upload-prev');
                const vid = document.getElementById('upload-vid');
                
                txt.style.display = 'none';
                img.style.display = 'none';
                vid.style.display = 'none';
                img.src = ''; vid.src = '';

                if(file.type.startsWith('video')) {
                    vid.src = URL.createObjectURL(file);
                    vid.style.display = 'block';
                } else {
                    img.src = URL.createObjectURL(file);
                    img.style.display = 'block';
                }
            },

            async uploadPost() {
                const inp = document.getElementById('file-inp');
                const cap = document.getElementById('upload-cap');
                
                if(!inp.files[0]) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                
                const form = new FormData();
                form.append('file', inp.files[0]);
                form.append('userId', this.user.id);
                form.append('caption', cap.value);
                form.append('type', inp.files[0].type.startsWith('video') ? 'video' : 'image');

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: /posts/create
                await fetch(`/posts/create`, { method: 'POST', body: form });
                
                alert('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
                inp.value = ''; cap.value = '';
                document.getElementById('upload-txt').style.display = 'block';
                document.getElementById('upload-prev').style.display = 'none';
                document.getElementById('upload-vid').style.display = 'none';
                this.nav('view-home');
            },

            // --- PROFILE & SEARCH ---
            async loadProfile(uid) {
                const cont = document.getElementById('profile-cont');
                cont.innerHTML = '<div style="padding:20px;text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: /users/:id
                const res = await fetch(`/users/${uid}`);
                if(!res.ok) return cont.innerHTML = '–û—à–∏–±–∫–∞';
                const { user, posts } = await res.json();
                
                const isMe = this.user.id === user.id;
                const isFollow = this.user.following.includes(user.id);
                const verifiedBadge = this.getVerifiedBadge(user.isVerified);

                cont.innerHTML = `
                    <div class="profile-header">
                        <img src="${user.avatar ? user.avatar : 'https://via.placeholder.com/90/333/333'}" class="profile-avatar">
                        <div style="display:flex; justify-content:center; align-items:center;">
                            <h2 style="margin:0; font-size: 24px;">@${user.username}</h2>
                            ${verifiedBadge}
                        </div>
                        
                        <div class="stats-row">
                            <div class="stat-box"><span class="stat-num">${user.following.length}</span><span class="stat-label">–ü–æ–¥–ø–∏—Å–∫–∏</span></div>
                            <div class="stat-box"><span class="stat-num" id="p-followers">${user.followers.length}</span><span class="stat-label">–§–∞–Ω–∞—Ç—ã</span></div>
                            <div class="stat-box"><span class="stat-num">${posts.length}</span><span class="stat-label">–ü–æ—Å—Ç—ã</span></div>
                        </div>

                        ${isMe 
                            ? `<button class="btn-small" onclick="document.getElementById('ava-up').click()">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                               <input type="file" id="ava-up" class="hidden" onchange="app.uploadAvatar(this)">` 
                            : `<button class="btn-primary" onclick="app.followUser('${user.id}', this)" style="background:${isFollow?'#333':'var(--primary)'}">
                                ${isFollow ? '–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}
                               </button>`
                        }
                    </div>
                    <div class="grid-posts">
                        ${posts.map(p => `
                            <div class="grid-item">
                                ${p.type==='video' ? '<video src="'+p.src+'"></video>' : '<img src="'+p.src+'">'}
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            async uploadAvatar(inp) {
                const form = new FormData();
                form.append('file', inp.files[0]);
                form.append('userId', this.user.id);
                await fetch(`/users/avatar`, { method: 'POST', body: form });
                this.loadProfile(this.user.id);
            },

            async followUser(tid, btn) {
                const res = await fetch(`/action/follow`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ currentId: this.user.id, targetId: tid })
                });
                const data = await res.json();
                if(data.error) return alert(data.error);

                if(data.isFollowing) this.user.following.push(tid);
                else this.user.following = this.user.following.filter(id => id !== tid);

                btn.innerText = data.isFollowing ? '–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                btn.style.background = data.isFollowing ? '#333' : 'var(--primary)';
                document.getElementById('p-followers').innerText = data.followersCount;
            },

            async search(q) {
                if(!q) return document.getElementById('search-results').innerHTML = '';
                const res = await fetch(`/users/search?q=${q}`);
                const list = await res.json();
                
                document.getElementById('search-results').innerHTML = list.map(u => `
                    <div class="user-list-item" onclick="app.loadProfile('${u.id}'); app.nav('view-profile')">
                        <img src="${u.avatar ? u.avatar : 'https://via.placeholder.com/40'}" class="avatar-circle">
                        <div class="username-container">
                            <span>${u.username}</span>
                            ${this.getVerifiedBadge(u.isVerified)}
                        </div>
                    </div>
                `).join('');
            }
        };

        // –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, —Å—Ä–∞–∑—É –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∏–ª–∏ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞)
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ –æ–¥–Ω–æ–º —Ö–æ—Å—Ç–µ.
        // window.onload = app.checkConnection; // –£–î–ê–õ–ï–ù–û
    </script>
</body>
</html>
